{"version":3,"sources":["../../src/ts/widgets/tooltipManager.ts"],"names":[],"mappings":"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","file":"tooltipManager.js","sourcesContent":["import { Autowired, Bean } from \"../context/context\";\nimport { Component } from \"./component\";\nimport { PopupService } from \"./popupService\";\nimport { UserComponentFactory } from \"../components/framework/userComponentFactory\";\nimport { GridOptionsWrapper } from \"../gridOptionsWrapper\";\nimport { ColumnApi } from \"../columnController/columnApi\";\nimport { GridApi } from \"../gridApi\";\nimport { CellComp } from \"../rendering/cellComp\";\nimport { ITooltipParams } from \"../rendering/tooltipComponent\";\nimport { ColDef } from \"../entities/colDef\";\nimport { _ } from \"../utils\";\n\ninterface TooltipTarget extends Component {\n    getTooltipText(): string;\n    getComponentHolder(): ColDef | undefined;\n\n}\n\ninterface RegisteredComponent {\n    tooltipComp?: Component;\n    destroyFunc?: () => void;\n    eventDestroyFuncs: (() => void)[];\n}\n\n@Bean('tooltipManager')\nexport class TooltipManager {\n\n    @Autowired('popupService') private popupService: PopupService;\n    @Autowired('userComponentFactory') private userComponentFactory: UserComponentFactory;\n    @Autowired('columnApi') private columnApi: ColumnApi;\n    @Autowired('gridApi') private gridApi: GridApi;\n    @Autowired('gridOptionsWrapper') private gridOptionsWrapper: GridOptionsWrapper;\n\n    private readonly DEFAULT_HIDE_TOOLTIP_TIMEOUT = 10000;\n    private readonly MOUSEOUT_HIDE_TOOLTIP_TIMEOUT = 1000;\n    private readonly MOUSEOVER_SHOW_TOOLTIP_TIMEOUT = 2000;\n    private readonly HIDE_SHOW_ONLY = true;\n\n    private showTimeoutId: number = 0;\n    private hideTimeoutId: number = 0;\n    private activeComponent: TooltipTarget | undefined;\n    private lastHoveredComponent: TooltipTarget | undefined;\n    private lastMouseEvent: MouseEvent | undefined;\n\n    // map of compId to [tooltip component, close function]\n    private registeredComponents: { [key: string]: RegisteredComponent } = {};\n\n    public registerTooltip(targetCmp: TooltipTarget): void {\n        const el = targetCmp.getGui();\n        const id = targetCmp.getCompId();\n\n        this.registeredComponents[id] = {\n            tooltipComp: undefined,\n            destroyFunc: undefined,\n            eventDestroyFuncs: [\n                targetCmp.addDestroyableEventListener(el, 'mouseover', (e) => this.processMouseOver(e, targetCmp)),\n                targetCmp.addDestroyableEventListener(el, 'mousemove', (e) => this.processMouseMove(e)),\n                targetCmp.addDestroyableEventListener(el, 'mousedown', this.hideTooltip.bind(this)),\n                targetCmp.addDestroyableEventListener(el, 'mouseout', this.processMouseOut.bind(this))\n            ]\n        };\n        targetCmp.addDestroyFunc(() => this.unregisterTooltip(targetCmp));\n    }\n\n    public unregisterTooltip(targetCmp: TooltipTarget): void {\n        const id = targetCmp.getCompId();\n        const registeredComponent = this.registeredComponents[id];\n\n        // hide the tooltip if it's being displayed while unregistering the component\n        if (this.activeComponent === targetCmp) {\n            this.hideTooltip();\n        }\n\n        if (targetCmp.isAlive() && registeredComponent && registeredComponent.eventDestroyFuncs.length) {\n            registeredComponent.eventDestroyFuncs.forEach(func => func());\n        }\n\n        delete this.registeredComponents[id];\n    }\n\n    private processMouseOver(e: MouseEvent, targetCmp: TooltipTarget) {\n        let delay = this.MOUSEOVER_SHOW_TOOLTIP_TIMEOUT;\n\n        if (this.activeComponent) {\n            // lastHoveredComponent will be the activeComponent when we are hovering\n            // a component with many child elements like the grid header\n            if (this.lastHoveredComponent === this.activeComponent) { return; }\n\n            delay = 200;\n        } else if (this.showTimeoutId && this.lastHoveredComponent === targetCmp) { return; }\n\n        this.clearTimers(this.HIDE_SHOW_ONLY);\n\n        // lastHoveredComponent will be the targetCmp when a click hid the tooltip\n        // and the lastHoveredComponent has many child elements\n        if (this.lastHoveredComponent === targetCmp) { return; }\n\n        this.lastHoveredComponent = targetCmp;\n        this.lastMouseEvent = e;\n        this.showTimeoutId = window.setTimeout(this.showTooltip.bind(this), delay, e);\n    }\n\n    private processMouseOut(e: MouseEvent) {\n        const activeComponent = this.activeComponent;\n        const relatedTarget = e.relatedTarget as HTMLElement;\n\n        if (!activeComponent) {\n            if (this.lastHoveredComponent) {\n                const containsElement = this.lastHoveredComponent.getGui().contains(relatedTarget);\n\n                if (this.showTimeoutId && containsElement) {\n                    // if we are hovering within a component with multiple child elements before\n                    // the tooltip has been displayed, we should cancel this event\n                    return;\n                } else if (!containsElement) {\n                    // when a click hides the tooltip we need to reset the lastHoveredComponent\n                    // otherwise the tooltip won't appear until another registered component is hovered.\n                    this.lastHoveredComponent = undefined;\n                }\n            }\n            this.clearTimers();\n            return;\n        }\n\n        // the mouseout was called from within the activeComponent so we do nothing\n        if (activeComponent.getGui().contains(relatedTarget)) {\n            return;\n        }\n\n        const registeredComponent = this.registeredComponents[activeComponent.getCompId()];\n        _.addCssClass(registeredComponent.tooltipComp.getGui(), 'ag-tooltip-hiding');\n        this.lastHoveredComponent = undefined;\n        this.clearTimers();\n        this.hideTimeoutId = window.setTimeout(this.hideTooltip.bind(this), this.MOUSEOUT_HIDE_TOOLTIP_TIMEOUT);\n    }\n\n    private processMouseMove(e: MouseEvent): void {\n        // there is a delay from the time we mouseOver a component and the time the\n        // tooltip is displayed, so we need to track mousemove to be able to correctly\n        // position the tooltip when showTooltip is called.\n        this.lastMouseEvent = e;\n    }\n\n    private showTooltip(e: MouseEvent): void {\n        const targetCmp = this.lastHoveredComponent;\n        const cellComp = targetCmp as CellComp;\n        const registeredComponent = this.registeredComponents[targetCmp.getCompId()];\n        this.hideTooltip();\n\n        const params: ITooltipParams = {\n            api: this.gridApi,\n            columnApi: this.columnApi,\n            colDef: targetCmp.getComponentHolder(),\n            column: cellComp.getColumn && cellComp.getColumn(),\n            context: this.gridOptionsWrapper.getContext(),\n            rowIndex: cellComp.getCellPosition && cellComp.getCellPosition().rowIndex,\n            value: targetCmp.getTooltipText()\n        };\n\n        this.createTooltipComponent(params, registeredComponent, e);\n    }\n\n    private createTooltipComponent(params: ITooltipParams, cmp: RegisteredComponent, e: MouseEvent): void {\n        const mouseEvent = this.lastMouseEvent;\n        if (!mouseEvent) {\n            return;\n        }\n        this.userComponentFactory.newTooltipComponent(params).then(tooltipComp => {\n            // if the component was unregistered while creating\n            // the tooltip (async) we should return undefined here.\n            if (!cmp) {\n                return;\n            }\n            cmp.tooltipComp = tooltipComp;\n            const eGui = tooltipComp.getGui();\n\n            if (!_.containsClass(eGui, 'ag-tooltip')) {\n                _.addCssClass(eGui, 'ag-tooltip-custom');\n            }\n\n            const closeFnc = this.popupService.addPopup(false, eGui, false);\n            cmp.destroyFunc = () => {\n                closeFnc();\n                if (tooltipComp.destroy) {\n                    tooltipComp.destroy();\n                }\n            };\n\n            this.popupService.positionPopupUnderMouseEvent({\n                type: 'tooltip',\n                mouseEvent: mouseEvent,\n                ePopup: eGui,\n                nudgeY: 18\n            });\n\n            this.activeComponent = this.lastHoveredComponent;\n            this.hideTimeoutId = window.setTimeout(this.hideTooltip.bind(this), this.DEFAULT_HIDE_TOOLTIP_TIMEOUT);\n        });\n    }\n\n    private hideTooltip(): void {\n        const activeComponent = this.activeComponent;\n\n        this.clearTimers();\n        if (!activeComponent) { return; }\n\n        const id = activeComponent.getCompId();\n        const registeredComponent = this.registeredComponents[id];\n\n        this.activeComponent = undefined;\n\n        if (!registeredComponent) { return; }\n        if (registeredComponent.destroyFunc) {\n            registeredComponent.destroyFunc();\n        }\n        this.clearRegisteredComponent(registeredComponent);\n    }\n\n    private clearRegisteredComponent(registeredComponent: RegisteredComponent) {\n        delete registeredComponent.destroyFunc;\n        delete registeredComponent.tooltipComp;\n    }\n\n    private clearTimers(showOnly: boolean = false): void {\n        if (this.hideTimeoutId && !showOnly) {\n            window.clearTimeout(this.hideTimeoutId);\n            this.hideTimeoutId = 0;\n        }\n\n        if (this.showTimeoutId) {\n            window.clearTimeout(this.showTimeoutId);\n            this.showTimeoutId = 0;\n        }\n    }\n}\n"]}